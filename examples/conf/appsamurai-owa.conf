# appsamurai-owa.conf - Partial Apache configuration for AppSamurai
#                       reverse proxy front end for Outlook Web Access
# $Id: appsamurai-owa.conf,v 1.3 2007/07/12 22:14:12 pauldoom Exp $

# This example should be customized for your environment and either
# added to your existing httpd.conf, or included into it.
# 
# All items that must be configured are surrounded by __, like
# "__OWASERVERFQDN__"   For clarity (at the expense of brevity), this is a
# plain config file.  (No <Perl> sections or mod_macro use.)     

# IMPORTANT: Your Exchange Outlook Web Access/ActiveSync server (referred to
# simply as "OWA server" below), must be properly configured for this to work!
# In addition, DNS and a properly laid out security perimeter are required.
# Finally, PLEASE do not deploy this system without some sort of strong
# authentication component for AppSamurai to use!
#
# For your OWA server:
# 1) SSL must be enabled and required on the OWA server. (A self-signed or
#    internal CA signed certificate is fine.)
# 2) You must have an internal DNS or hosts file entry pointing
#    the FQDN of your server to its real IP address inside your network.
# 3) Basic Authentication must be configured (Form based login breaks
#    ActiveSync.  This config is for a Basic Auth backend only.)
# 4) You should be able to use OWA (https://servername.domain/exchange/)
#    from inside your network.
# 5) You should be able to use ActiveSync with a device attached to your
#    internal network.  (Microsoft's Windows Mobile emulator is helpful
#    for testing.)
#
# For your AppSamurai server:
# 1) You must have a SSL certificate signed by a trusted CA.
# 2) You must have an EXTERNAL DNS entry pointing the FQDN of your OWA
#    server to the external IP (or NAT IP) your AppSamurai proxy will be
#    available from.
#
# On your firewall: 
# 1) Open up access to port 443 on your AppSamurai proxy
# 2) Open access from your AppSamurai server's real IP to port 443 of your
#    OWA server
# 3) Open access from your AppSamurai server's real IP to any authentication
#    services it will be using.
#
# Reference:
# * http://3cx.org/item/38 - Very helpful HowTo on setting up Apache to proxy
#    OWA.  (This is only for reference: All the directives you need should
#    already be in this configuration example.)
# * I would point to a good doc on setting up OWA and ActiveSync, but I can't
#   recommend any.  Search technet.microsoft.com and Google as needed.

# The following modules are required for this setup:
LoadModule rewrite_module	/usr/lib/apache/modules/mod_rewrite.so
LoadModule proxy_module	/usr/lib/apache/modules/libproxy.so
LoadModule perl_module        /usr/lib/apache/modules/mod_perl.so

# Load the main AppSamurai module and the mod_perl registry
PerlModule Apache::AppSamurai
PerlModule Apache::Registry

# Enables warnings and taint checking
PerlWarn On
PerlTaintCheck On

#### AppSamurai Setup ####
# We with use the auth_name "Owa" for this sample.  If you prefer
# "TheMagnificentRonnieWilson" instead, just replace "Owa" with
# that in each PerlSetVar line.
#
# Set to 1 for debugging (only for troubleshooting or non-production testing,
# as this produces a TON of noise, and leeks some semi-sensitive info,
# into the Apache error logs)  (Default: 0)
PerlSetVar OwaDebug 0

# Name of authentication cookie
PerlSetVar OwaCookieName ChocholateChipOfDoom

# Path to set on authentication cookie  (Default: /)
PerlSetVar OwaPath /

# Point to the form login page/script
PerlSetVar OwaLoginScript /AppSamurai/login.pl

# Must satisfy all authentication checks (Default: All)
PerlSetVar OwaSatisfy All

# Set the "secure" flag on the authentication cookie (Note - If you are not
# using SSL, well, USE SSL!!!)
PerlSetVar OwaSecure 1

# Set the silly Microsoft http-only cookie flag
PerlSetVar OwaHttpOnly 1

# Custom mapping of xxxxxx;yyyyyy Basic authentication password input
# to specific and seperate individual credentials.
# Example: If the user logs into the basic auth popup with the password:
#		myRockinPassword;1234123456
# The map below will set credential_1 as "1234123456" and credential_2
# as "myRockinPassword", then proceed as if the same were enterred into
# a form login.  (Default: undef)
PerlSetVar OwaBasicAuthMap "2,1=(.+);([^;]+)"

# List the authentication methods (modules) you will be using, in order of
# credential number on the login form.  (credential_1, credential_2, etc)
PerlSetVar OwaAuthMethods "AuthRadius,AuthBasic"

# AuthUnique forces each login attempt to use different credentials.
# This is only usable for cases in which OTP or a token of some sort is
# part of the mix.  (Highly recommended!)
# (Note - Uses the Tracker system) (Default: 0)
PerlSetVar OwaAuthUnique 1

## AppSamurai::AuthBasic options
#
# The URL to send basic authentication checks to
PerlSetVar OwaAuthBasicLoginUrl "https://__OWASERVERFQDN__/exchange/"

# Use the special "HEADER:<field>" to pass the named header field from
# the client to the backend authenticator directly.  (Default: undef)
PerlSetVar OwaAuthBasicUserAgent "header:User-Agent"

# Abort the check unless the "realm" returned by the server matches
# this string.  (Note - most OWA servers use the Active Directory
# domain as the realm.  Try a direct login to the backend server to check.)
# (Default: undef)
PerlSetVar OwaAuthBasicRequireRealm "__OWASERVERLOGINREALM__"

# Continue to send the same Authorization: header to the backend server
# after login.  (Only use this when the AuthBasic check is run against
# the backend server you are protecting)  (Default: 1)
PerlSetVar OwaAuthBasicKeepAuth 1

# Collect cookes from AuthBasic check and send back to the user's browser
# on login  (Default: 1)
PerlSetVar OwaAuthBasicPassBackCookies 1

## AppSamurai::AuthRadius options
#
# Set the IP and port to send Radius requests to
PerlSetVar OwaAuthRadiusConnect "__RADIUSSERVERIP__:__RADIUSPORT__"

# Set the RADIUS key to use
PerlSetVar OwaAuthRadiusSecret "__RADIUSPASSWORD__"


## Session storage options
#
# Inactivity timeout (in seconds) for normal (form based) OWA sessions
# (Default: 3600)
PerlSetVar OwaSessionTimeout 3600

# This is the AppSamurai instance's password.  Set it to something long.
# All AppSamurai servers in a cluster (sharing the same auth name), and
# using a common storage area (central session database server), should
# use the same ServerPass so they can all check and decrypt stored session
# data.
# (Note - ServerKey is only used with HMAC session generators and
#  encrypting session serializers: Both are on by default)
PerlSetVar OwaSessionServerPass "Wouldn't you like to know?"

# If using th default File session store, you must point to a filesystem
# directory to store sessions in.  (Should be readable/writable only to
# the user httpd is running under)
PerlSetVar OwaSessionDirectory "/var/www/session/sessions"
# Ditto for the file lock type
PerlSetVar OwaSessionLockDirectory "/var/www/session/slock"

## Tracker System
#
# Cleanup items older than this many seconds (Default: undef)
PerlSetVar OwaTrackerCleanup 86400

## Misc Features
#
# IPFailures takes an argument in the format "X:Y", where X is the number of
# failures and Y is the window (in seconds) between the failures.
# Note - If TrackerCleanup is LESS than the failure window, you may miss
# slow attacks.  (Default: undef)
PerlSetVar OwaIPFailures "20:60"

## Directory and Location Configuration
#

# AppSamurai login/logout pages
<Directory "/var/www/htdocs/AppSamurai">
 AllowOverride None
 deny from all

 <FilesMatch "\.pl$">
  # The login and logout pages are Perl scripts, so we enable normal
  # mod_perl CGI handling for them
  SetHandler perl-script
  PerlHandler Apache::Registry
  Options +ExecCGI
  AuthType Apache::AppSamurai

  # IMPORTANT - The auth name MUST match a configured AppSamurai auth name
  AuthName "Owa"
  allow from all
 </FilesMatch>

 <Files LOGIN>
  # This is a fake file that is mapped to the login() method in
  # Apache::AppSamurai (Your login page should post to this)
  SetHandler perl-script
  AuthType Apache::AppSamurai

  # IMPORTANT - The auth name MUST match a configured AppSamurai auth name
  AuthName "Owa"

  # Map to method	
  PerlHandler Apache::AppSamurai->login
  allow from all
 </Files>

</Directory>


# Images used on AppSamurai login page
<Directory "/var/www/htdocs/AppSamurai/images">
 Options None
 AllowOverride None
 allow from all
</Directory>

# Local copies of static OWA content (images, styles, etc)
# This is to speed up serving of things that need no protection.  You
# need to copy these folders from your OWA server if you wish to use
# this setup, and properly configure your rewrite rules for it (below)
<Directory "/var/www/htdocs/exchweb">
    AllowOverride None
    Order allow,deny
    Allow from all
</Directory>

# Protect ALL proxied areas (by default)  The actual proxy mapping is
# done with rewrite rules.  (Be careful if you decide to make this 
# a more specific path:  You do not want to expose internal servers!)
<Directory proxy:*>
  AuthType Apache::AppSamurai

  # IMPORTANT - The auth name MUST match a configured AppSamurai auth name
  AuthName "Owa"

  # Map authentication checks to this method
  PerlAuthenHandler Apache::AppSamurai->authenticate
  # Map authorization checks to this method
  PerlAuthzHandler Apache::AppSamurai->authorize

  # Allow all IPs, but require a logged in user
  Order deny,allow
  Allow from all
  Require valid-user
</Directory>

# Special ActiveSync configuration: Protects /Microsoft-Server-ActiveSync
# path with Basic Authentication login instead of form based.  This is
# to support Windows Mobile devices.  Other special parameters are used
# to support the non-cookie aware ActiveSync
<Directory proxy:https://__OWASERVERFQDN__/Microsoft-Server-ActiveSync*>
  # Set hard exiration (no matter what, the session is killed after this
  # many seconds)
  PerlSetVar OwaSessionExpire 86400

  # Override the previously configured inactivity timer (only applies to this
  # directory)  0 disables the timer
  PerlSetVar OwaSessionTimeout 0

  # ActiveSync does not maintain session cookies.  This sets up a "custom
  # keysource" to compute the session authentication key based on a set of
  # headers and arguments.  (Sort of a pseudo-cookie).  This avoids losing
  # sessions with ActiveSync.  It is MUCH less secure, though!  Only
  # use this in conjuntion with at least one token or OTP based authentication
  # module.  (SecurID, SafeWord, etc....)  This custom keysource uses:
  #  1) The "Authorization" header value
  #  2) The "User-agent" header value
  #  3) The "User" argument (ActiveSync devices add this to each request)
  #  4) The "DeviceId" argument (ActiveSync adds this, and it should be unique
  #     per-device... not that it couldn't be spoofed)
  PerlAddVar OwaKeysource header:Authorization
  PerlAddVar OwaKeysource header:User-agent
  PerlAddVar OwaKeysource arg:User
  PerlAddVar OwaKeysource arg:DeviceId

  # Note that "Basic" is used instead of "Apache::AppSamurai".  This causes
  # Apache to handle the basic authentication grunt work for us
  AuthType Basic

  # IMPORTANT - The auth name MUST match a configured AppSamurai auth name
  AuthName "Owa"

  # Map authentication checks to this method
  PerlAuthenHandler Apache::AppSamurai->authenticate
  # Map authorization checks to this method
  PerlAuthzHandler Apache::AppSamurai->authorize

  # Allow all IPs, but require a logged in user
  Order deny,allow
  Allow from all
  require valid-user
</Directory>


#### Rewrite/Proxy Rules ####
# Note - this section is commonly embedded inside a VirtualHost section,
# often for the SSL default virtual host
#
# Enable rewrites
RewriteEngine  On

# Turn off client proxy requests (All requests mapped by Rewrite)
ProxyRequests Off

# Block by default
RewriteRule ^(http|ftp|https)://.* - [F]

# Block access to common IIS hackable areas
RewriteRule ^(.*)?/iisadmin/? - [F,L]
RewriteRule ^(.*)?/samples/? - [F,L]
RewriteRule ^(.*)?/scripts/? - [F,L]
RewriteRule ^(.*).ida$ - [F,L]
RewriteRule ^(.*).htw$ - [F,L]
RewriteRule ^(.*)./_vti/_. - [F,L]
RewriteRule ^(.*).idq$ - [F,L]
RewriteRule ^(.*).exe$        -       [F]
RewriteRule ^(.*)?/winnt/?    - [F,L]

# Redirect our default into the main OWA app
RewriteRule ^/?$ /exchange/ [R,L]

# Remap logout URLs to our AppSamurai logout page
RewriteRule ^/exchweb/bin/.*logoff\.asp$     /AppSamurai/logout.pl	[L]

# Reverse proxy (P) /public/
RewriteRule ^/public/(.*)$   https://__OWASERVERFQDN__/public/$1 [P,L]

# Use local copies static /exchweb/ content (uncomment these unless you have
# copied the listed folders from your OWA server over to your AppSamurai proxy)
RewriteRule ^/exchweb/controls/ - [L]
RewriteRule ^/exchweb/img/      - [L]
RewriteRule ^/exchweb/themes/   - [L]
RewriteRule ^/exchweb/views/    - [L]

# Reverse proxy items in /exchweb/, /exchange/, and /iisadmpwd/
RewriteRule ^/exchweb/(.*)$   https://__OWASERVERFQDN__/exchweb/$1 [P,L]
RewriteRule ^/exchange/(.*)$  https://__OWASERVERFQDN__/exchange/$1 [P,L]
RewriteRule ^/iisadmpwd/(.*)$   https://__OWASERVERFQDN__/iisadmpwd/$1 [P,L]

# ActiveSync - For Windows Mobile devices (requires special setup - See
# corresponding directory section for it above)
RewriteRule ^/Microsoft-Server-ActiveSync(.*)$  https://__OWASERVERFQDN__/Microsoft-Server-ActiveSync$1 [P,L]

# Outlook Remote Access - Currenty not tested (RPC over HTTP makes me nautious)
#RewriteRule ^/rpc/(.*)$    https://__OWASERVERFQDN__/rpc/$1 [P,L]

# /AppSamurai/ files are local to the proxy
RewriteRule ^/AppSamurai - [L]

# Allow in robots.txt access.  Please consider using one!  You will need to
# place it into your document root directory, or setup an alias.
# Here is the suggested content:
#
#  User-agent: *
#  Disallow: /
# 
RewriteRule ^/robots.txt - [L]

# send everything else to forbidden (Yea, I set a default deny up top, too.)
RewriteRule .* - [F,L]
